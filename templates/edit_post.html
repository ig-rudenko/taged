<!DOCTYPE html>
{% load static %}
<html lang="ru">
<link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
<head>
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/tags.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/checkselect.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/menu.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/buttons.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/upload_file.css' %}" />
    <script src="{% static 'js/jquery.min.js' %}"></script>

    <script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>


    <meta charset="UTF-8">
    <title>Создание заметки</title>
</head>

<body style="height: 80%">
    <ul class="menu-main" style="padding: 20px">
      <li><a href="/">Поиск</a></li>
      <li><a href="/create" class="current">Создать Заметку</a></li>
      <li><a href="/books">Библиотека</a></li>
        {% if user.is_superuser %}
      <li><a href="/tags">Теги</a></li>
      <li><a href="/users">Пользователи</a></li>
        {% endif %}
      <li><a href="/logout">Выйти</a></li>
    </ul>
<div>
    <img id="cat-run" src="/static/images/cat_run.gif" width="100" style="left: -100px; z-index: 999">
</div>
    <form name="theForm" method="post" style="height: 100%" enctype="multipart/form-data">
        {% csrf_token %}

        {# КНОПКА ОПУБЛИКОВАТЬ #}
        <div class="button-wrapper">
            <a class="arrow-btn" onclick="document.theForm.submit()">Опубликовать<span></span></a>
        </div>
        <h4 style="color: darkred; text-align: center">{{ error }}</h4>

        {# СПИСОК ТЕГОВ #}
        <div style="text-align: right">
            <div class="checkselect">

            {% for t in tags %}
            <label style="float:left">
                <input type="checkbox" name="tags_checked" value="{{ t.tag }}" {% if t.checked %} checked {% endif %}>
                {{ t.tag }}
            </label>
            {% endfor %}
            </div>
        </div>

        <div id="tag-start-tags_checked"></div> {# МЕСТО ДЛЯ ТЕГОВ #}

        {# ФАЙЛЫ #}
        <div class="upload_form">
            <label>
                <input id="files" name="files" type="file" class="main_input_file" multiple />
                <img src="{% static "/images/icons/clip.png" %}" alt="clip">
                <div>Прикрепить</div>
            </label>
        </div>
        {# СУЩЕСТВУЮЩИЕ ФАЙЛЫ #}
        <div class="post-file">
            {% for f in files %}
                <a id="file_{{ f.name }}">
                    <img src="{% static f.icon %}" width="40px" height="40px" alt="">
                    {{ f.name }}
                </a>
                <a onclick="delete_file('{{ f.name }}')">X</a>
                <input id="checkbox_{{ f.name }}" name="checkbox_{{ f.name }}" type="checkbox" hidden checked>
            {% endfor %}
        </div>
        <div id="file_list"></div>

        {# ХРАНЕНИЕ ID ЗАПИСИ #}
        <input type="text" name="post_id" value="{{ post_id }}" hidden readonly>

        {# TITLE #}
        {{ form.title }}

        {# CONTENT #}
{#        <textarea id="input" name="input" required>{{ content }}</textarea>#}

        <div style="width: 100%">
            {{ form.input }}
        </div>
    </form>

    {# РАБОТА С ОТОБРАЖЕНИЕМ ТЕГОВ #}
<script src="{% static 'js/tags_control.js' %}"></script>
<script>

    $(document).ready ( function(){
        $(".django-ckeditor-widget").css({"width" : "100%"});
        $("#cke_id_input").css({"width" : ''});
    });

function file_format(file_name) {
    if (file_name.endsWith('.docx') || file_name.endsWith('.doc') || file_name.endsWith('.rtf')){
        return 'docx'
    }
    if (file_name.endsWith('.xls') || file_name.endsWith('.xlsx') || file_name.endsWith('.xlsm')){
        return 'xlsx'
    }
    if (file_name.endsWith('.pdf')){
        return 'pdf'
    }
    if (file_name.endsWith('.xml')){
        return 'xml'
    }
    if (file_name.endsWith('.drawio')){
        return 'drawio'
    }
    if (file_name.endsWith('.txt')){
        return 'txt'
    }
    if (file_name.endsWith('.vsd') || file_name.endsWith('.vsdx')){
        return 'visio'
    }
    if (file_name.endsWith('.png') || file_name.endsWith('.jpeg') || file_name.endsWith('.jpg') || file_name.endsWith('.gif') || file_name.endsWith('.bpm')){
        return 'img'
    }
    if (file_name.endsWith('.rar') || file_name.endsWith('.7z') || file_name.endsWith('.zip') || file_name.endsWith('.tar') || file_name.endsWith('.iso')){
        return 'archive'
    }
    return 'file'
}

function delete_file(file_name){
    console.log(document.getElementById('file_' + file_name).style.backgroundColor)
    if (document.getElementById('file_' + file_name).style.backgroundColor === 'red'){
        document.getElementById('file_' + file_name).style.backgroundColor = 'white';
        document.getElementById('checkbox_' + file_name).checked = true;
    } else {
        document.getElementById('file_' + file_name).style.backgroundColor = 'red';
        document.getElementById('checkbox_' + file_name).checked = false;
    }
}

$(document).ready(function() {

    $(".main_input_file").change(function() {

        console.log('next')
        console.log($(this).get(0).files)
        var files_html_ = '<div class="post-file">'

        for (var i = 0; i < $(this).get(0).files.length; ++i) {
            files_html_ += `<a><img src="/static/images/icons/`+file_format($(this).get(0).files[i].name)+
                `.png" width="40px" height="40px" alt="">`+$(this).get(0).files[i].name+`</a>`
        }

        document.getElementById('file_list').innerHTML = files_html_ + '</div>'
    });
});

</script>
</body>
</html>